name: Mend Security Scan (SCA + SAST)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  mend:
    runs-on: ubuntu-latest

    env:
      # ===== Mend Authentication =====
      MEND_EMAIL: ${{ secrets.MEND_EMAIL }}
      MEND_USER_KEY: ${{ secrets.MEND_USER_KEY }}
      MEND_URL: ${{ secrets.MEND_URL }}

      # ===== Mend Scope (cria App e Project automaticamente) =====
      # Formato: Organization//Application//Project
      MEND_SCOPE: "NOVA8 Advise Azure GitHub Jenkins//CLI//mern-amazona-docker"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Mend CLI
        run: |
          curl -L https://downloads.mend.io/cli/linux/mend -o mend
          chmod +x mend
          sudo mv mend /usr/local/bin/mend

      - name: Mend Version
        run: mend version

      - name: Mend Auth Info (debug)
        run: mend auth info
        continue-on-error: true

      # ==============================
      # SCA – Software Composition Analysis
      # ==============================
      - name: Mend SCA Scan (Dependencies)
        run: |
          mend dep \
            --scope "$MEND_SCOPE" \
            --update \
            --non-interactive \
            --persist-logs

      # ==============================
      # SAST – Static Application Security Testing
      # ==============================
      - name: Mend SAST Scan (Code)
        run: |
          mend code \
            --scope "$MEND_SCOPE" \
            --non-interactive \
            --persist-logs
